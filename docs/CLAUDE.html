<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>CLAUDE.md for probmed Package • probmed</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"><link rel="icon" sizes="any" href="favicon.ico"><link rel="manifest" href="site.webmanifest"><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/Inter-0.4.10/font.css" rel="stylesheet"><link href="deps/Fira_Code-0.4.10/font.css" rel="stylesheet"><link href="deps/Montserrat-0.4.10/font.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="CLAUDE.md for probmed Package"><meta property="og:image" content="https://data-wise.github.io/probmed/reference/figures/logo.png"><meta property="og:image:alt" content="probmed: Probabilistic Effect Sizes for Mediation Analysis"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:creator" content="@dtofighi"><meta name="twitter:site" content="@dtofighi"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">probmed</a>

    <small class="nav-text text-default me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="index.html" aria-label="Home"><span class="fa fas fa-home fa-lg"></span></a></li>
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes"><li><a class="dropdown-item" href="articles/introduction.html">Introduction to probmed</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>─────────────</h6></li>
    <li><h6 class="dropdown-header" data-toc-skip>Integration Guides</h6></li>
    <li><a class="dropdown-item" href="articles/lavaan-integration.html">lavaan Integration</a></li>
    <li><a class="dropdown-item" href="articles/mediation-integration.html">mediation Package Integration</a></li>
    <li><a class="dropdown-item" href="articles/package-comparison.html">Package Comparison</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">News</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/data-wise/probmed" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="logo.png" class="logo" alt=""><h1>CLAUDE.md for probmed Package</h1>
      <small class="dont-index">Source: <a href="https://github.com/data-wise/probmed/blob/HEAD/CLAUDE.md" class="external-link"><code>CLAUDE.md</code></a></small>
    </div>


<div id="claudemd-for-probmed-package" class="section level1">

</div>
<div class="section level1">
<h1 id="claudemd">CLAUDE.md<a class="anchor" aria-label="anchor" href="#claudemd"></a></h1>
<p>This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.</p>
<div class="section level2">
<h2 id="about-this-package">About This Package<a class="anchor" aria-label="anchor" href="#about-this-package"></a></h2>
<p>probmed is an R package for computing P_med, a scale-free probabilistic effect size for causal mediation analysis. P_med quantifies mediation effects as the probability that the counterfactual outcome under treatment with the mediator at its control level exceeds the counterfactual outcome under control: P(Y_{x*,M_x} &gt; Y_{x,M_x}).</p>
<div class="section level3">
<h3 id="core-mission">Core Mission<a class="anchor" aria-label="anchor" href="#core-mission"></a></h3>
<p>Provide researchers with a scale-free, interpretable effect size measure for mediation analysis that works consistently across mixed variable types (binary, continuous) and avoids the limitations of traditional mean-difference approaches. Methods accommodate both simple and complex mediation models while maintaining accessibility for applied practitioners.</p>
</div>
<div class="section level3">
<h3 id="key-features">Key Features<a class="anchor" aria-label="anchor" href="#key-features"></a></h3>
<ul><li>
<strong>Scale-free interpretation</strong>: P_med ∈ [0, 1] has clear probabilistic meaning regardless of variable scales</li>
<li>
<strong>Flexible estimation</strong>: Works with GLMs, SEM (via lavaan), and other fitted models</li>
<li>
<strong>Multiple mediators</strong>: Supports parallel and sequential mediation structures</li>
<li>
<strong>Interactions</strong>: Handles exposure-mediator interactions with conditioning</li>
<li>
<strong>Bootstrap inference</strong>: Parametric and nonparametric bootstrap for confidence intervals</li>
<li>
<strong>S7 OOP architecture</strong>: Modern, type-safe object system for extensibility</li>
</ul></div>
<div class="section level3">
<h3 id="key-references">Key References<a class="anchor" aria-label="anchor" href="#key-references"></a></h3>
<ul><li>McGraw &amp; Wong (1992): Common language effect size statistics (<em>Psychological Bulletin</em>)</li>
<li>Vargha &amp; Delaney (2000): Critique and improvement of CL effect sizes (<em>Journal of Educational and Behavioral Statistics</em>)</li>
<li>Imai, Keele, &amp; Tingley (2010): General approach to causal mediation analysis (<em>Psychological Methods</em>)</li>
<li>VanderWeele &amp; Vansteelandt (2014): Mediation analysis with multiple mediators (<em>European Journal of Epidemiology</em>)</li>
<li>Tofighi et al. (2025): P_med manuscript (target: <em>Psychological Methods</em>)</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="common-development-commands">Common Development Commands<a class="anchor" aria-label="anchor" href="#common-development-commands"></a></h2>
<div class="section level3">
<h3 id="package-building-and-checking">Package Building and Checking<a class="anchor" aria-label="anchor" href="#package-building-and-checking"></a></h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install package dependencies</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"remotes"</span>, <span class="st">"rcmdcheck"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_deps.html" class="external-link">install_deps</a></span><span class="op">(</span>dependencies <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check package (standard R CMD check)</span></span>
<span><span class="fu">rcmdcheck</span><span class="fu">::</span><span class="fu"><a href="http://r-lib.github.io/rcmdcheck/reference/rcmdcheck.html" class="external-link">rcmdcheck</a></span><span class="op">(</span>args <span class="op">=</span> <span class="st">"--no-manual"</span>, error_on <span class="op">=</span> <span class="st">"error"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build package</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/build.html" class="external-link">build</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Install and reload package during development</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/load_all.html" class="external-link">load_all</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="documentation">Documentation<a class="anchor" aria-label="anchor" href="#documentation"></a></h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate documentation from roxygen2 comments</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/document.html" class="external-link">document</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build PDF manual</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/build_manual.html" class="external-link">build_manual</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build pkgdown site</span></span>
<span><span class="fu">pkgdown</span><span class="fu">::</span><span class="fu"><a href="https://pkgdown.r-lib.org/reference/build_site.html" class="external-link">build_site</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="testing-and-linting">Testing and Linting<a class="anchor" aria-label="anchor" href="#testing-and-linting"></a></h3>
<p>The package uses GitHub Actions for CI/CD with workflows defined in <code>.github/workflows/</code>:</p>
<ul><li>
<code>R-CMD-check.yaml</code>: R package check on multiple OS and R versions</li>
<li>
<code>test-coverage.yaml</code>: Test coverage via covr</li>
<li>
<code>pkgdown.yaml</code>: Documentation website deployment</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="coding-standards">Coding Standards<a class="anchor" aria-label="anchor" href="#coding-standards"></a></h2>
<div class="section level3">
<h3 id="r-version-and-style">R Version and Style<a class="anchor" aria-label="anchor" href="#r-version-and-style"></a></h3>
<ul><li>
<strong>Minimum R version</strong>: 4.1.0 (native pipe |&gt; support)</li>
<li>
<strong>OOP Framework</strong>: S7 (modern object system)</li>
<li>
<strong>Style</strong>: tidyverse style guide with native pipe</li>
<li>
<strong>Roxygen2</strong>: Use roxygen2 for documentation (&gt;= 7.2.0)</li>
<li>
<strong>Clarity priority</strong>: Code must be readable for both methodologists and applied users</li>
</ul></div>
<div class="section level3">
<h3 id="naming-conventions">Naming Conventions<a class="anchor" aria-label="anchor" href="#naming-conventions"></a></h3>
<p>The package uses <strong>snake_case</strong> consistently following tidyverse conventions:</p>
<p><strong>Functions:</strong></p>
<ul><li>Main exports: <code><a href="reference/pmed.html">pmed()</a></code>, <code><a href="reference/extract_mediation.html">extract_mediation()</a></code>
</li>
<li>S7 generics follow convention: <code><a href="reference/extract_mediation.html">extract_mediation()</a></code>, <code><a href="reference/pmed.html">pmed()</a></code>
</li>
<li>Internal functions prefix with dot: <code>.pmed_core()</code>, <code><a href="reference/dot-pmed_parametric_boot.html">.pmed_parametric_boot()</a></code>
</li>
</ul><p><strong>Arguments:</strong></p>
<ul><li>
<code>formula_y</code>, <code>formula_m</code> for model specifications</li>
<li>
<code>treatment</code>, <code>mediator</code>, <code>outcome</code> for variable names</li>
<li>
<code>x_ref</code>, <code>x_value</code> for treatment contrast</li>
<li>
<code>method</code> for inference method: “parametric_bootstrap”, “nonparametric_bootstrap”, “plugin”</li>
<li>
<code>n_boot</code> for number of bootstrap samples</li>
<li>
<code>ci_level</code> for confidence level (default: 0.95)</li>
</ul><p><strong>S7 Classes:</strong></p>
<ul><li>CamelCase: <code>MediationExtract</code>, <code>PmedResult</code>
</li>
<li>Properties use snake_case: <code>@a_path</code>, <code>@b_path</code>, <code>@ci_lower</code>
</li>
</ul></div>
<div class="section level3">
<h3 id="code-organization">Code Organization<a class="anchor" aria-label="anchor" href="#code-organization"></a></h3>
<pre><code>R/
├── aaa-imports.R           # Package imports and setup
├── classes.R               # S7 class definitions
├── generics.R              # S7 generic functions
├── methods-extract.R       # extract_mediation() methods
├── methods-pmed.R          # pmed() methods
├── methods-print.R         # print(), summary(), plot() methods
├── compute-core.R          # Core P_med computation
├── compute-bootstrap.R     # Bootstrap implementations
└── utils.R                 # Utility functions</code></pre>
</div>
</div>
<div class="section level2">
<h2 id="code-architecture">Code Architecture<a class="anchor" aria-label="anchor" href="#code-architecture"></a></h2>
<div class="section level3">
<h3 id="s7-object-system">S7 Object System<a class="anchor" aria-label="anchor" href="#s7-object-system"></a></h3>
<p>The package uses S7 for type-safe, modern object-oriented programming:</p>
<p><strong>Key S7 Classes:</strong></p>
<ol style="list-style-type: decimal"><li>
<strong><code>MediationExtract</code></strong> - Extracted mediation structure from fitted models
<ul><li>Properties: <code>estimates</code>, <code>a_path</code>, <code>b_path</code>, <code>c_prime</code>, <code>vcov</code>, <code>data</code>, etc.</li>
<li>Validation rules ensure internal consistency</li>
<li>Subclasses: <code>MediationExtractLavaan</code> for lavaan-specific properties</li>
</ul></li>
<li>
<strong><code>PmedResult</code></strong> - P_med computation results
<ul><li>Properties: <code>estimate</code>, <code>ci_lower</code>, <code>ci_upper</code>, <code>method</code>, <code>boot_estimates</code>, etc.</li>
<li>Validator checks P_med ∈ [0, 1] and CI consistency</li>
<li>Source tracking via <code>source_extract</code> property</li>
</ul></li>
</ol><p><strong>S7 Generics:</strong></p>
<ol style="list-style-type: decimal"><li>
<strong><code><a href="reference/extract_mediation.html">extract_mediation()</a></code></strong> - Extract mediation structure from models
<ul><li>Methods: <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">stats::lm</a></code>, <code>lavaan</code>, <code>mediation</code>, etc.</li>
<li>Returns: <code>MediationExtract</code> object</li>
</ul></li>
<li>
<strong><code><a href="reference/pmed.html">pmed()</a></code></strong> - Compute P_med from various inputs
<ul><li>Methods: <code>formula</code>, <code>MediationExtract</code>
</li>
<li>Returns: <code>PmedResult</code> object</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="core-function-hierarchy">Core Function Hierarchy<a class="anchor" aria-label="anchor" href="#core-function-hierarchy"></a></h3>
<p><strong>User-Facing Functions:</strong></p>
<ol style="list-style-type: decimal"><li>
<strong><code>pmed(formula_y, formula_m, ...)</code></strong> - Formula interface (most common)
<ul><li>Fits GLMs automatically</li>
<li>Dispatches to appropriate computation method</li>
<li>Returns <code>PmedResult</code> with CI</li>
</ul></li>
<li>
<strong><code>pmed(object, ...)</code></strong> - Works with <code>MediationExtract</code>
<ul><li>For pre-extracted structures</li>
<li>More flexible for custom models</li>
</ul></li>
<li>
<strong><code>extract_mediation(object, ...)</code></strong> - Extract from fitted models
<ul><li>Generic with methods for lm/glm, lavaan, mediation, medflex</li>
<li>Standardizes across packages</li>
<li>Returns <code>MediationExtract</code>
</li>
</ul></li>
</ol><p><strong>Internal Computation Functions:</strong></p>
<ul><li>
<code><a href="reference/dot-pmed_compute.html">.pmed_compute()</a></code>: Main dispatcher</li>
<li>
<code><a href="reference/dot-pmed_plugin.html">.pmed_plugin()</a></code>: Point estimate only</li>
<li>
<code><a href="reference/dot-pmed_parametric_boot.html">.pmed_parametric_boot()</a></code>: Parametric bootstrap</li>
<li>
<code><a href="reference/dot-pmed_nonparametric_boot.html">.pmed_nonparametric_boot()</a></code>: Nonparametric bootstrap</li>
<li>
<code><a href="reference/dot-pmed_core_simple.html">.pmed_core_simple()</a></code>: Core P_med calculation</li>
</ul></div>
<div class="section level3">
<h3 id="key-dependencies">Key Dependencies<a class="anchor" aria-label="anchor" href="#key-dependencies"></a></h3>
<p><strong>Required:</strong></p>
<ul><li>
<strong>S7</strong>: Modern object system</li>
<li>
<strong>stats</strong>: GLM fitting and prediction</li>
<li>
<strong>methods</strong>: S3/S4 compatibility checks</li>
<li>
<strong>alabama</strong>: Constrained optimization (for MBCO extensions)</li>
</ul><p><strong>Suggested:</strong></p>
<ul><li>
<strong>MASS</strong>: <code>mvrnorm()</code> for parametric bootstrap</li>
<li>
<strong>lavaan</strong>: SEM model support</li>
<li>
<strong>mediation</strong>: mediation package integration</li>
<li>
<strong>medflex</strong>: Natural effects framework support</li>
</ul></div>
<div class="section level3">
<h3 id="explicit-namespacing">Explicit Namespacing<a class="anchor" aria-label="anchor" href="#explicit-namespacing"></a></h3>
<p><strong>CRITICAL</strong>: All non-base functions MUST use explicit namespacing:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># CORRECT</span></span>
<span><span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">formula</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="fu">lavaan</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lavaan/man/sem.html" class="external-link">sem</a></span><span class="op">(</span><span class="va">model</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">mu</span>, <span class="va">Sigma</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># INCORRECT</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">formula</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="fu">sem</span><span class="op">(</span><span class="va">model</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="fu">mvrnorm</span><span class="op">(</span><span class="va">n</span>, <span class="va">mu</span>, <span class="va">Sigma</span><span class="op">)</span></span></code></pre></div>
<p>This prevents namespace conflicts and makes dependencies explicit.</p>
</div>
</div>
<div class="section level2">
<h2 id="important-implementation-details">Important Implementation Details<a class="anchor" aria-label="anchor" href="#important-implementation-details"></a></h2>
<div class="section level3">
<h3 id="p_med-definition">P_med Definition<a class="anchor" aria-label="anchor" href="#p_med-definition"></a></h3>
<p>For treatment X, mediator M, and outcome Y:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mtext mathvariant="normal">med</mtext></msub><mo>=</mo><mi>P</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>Y</mi><mrow><msup><mi>x</mi><mo>*</mo></msup><mo>,</mo><msub><mi>M</mi><mi>x</mi></msub></mrow></msub><mo>&gt;</mo><msub><mi>Y</mi><mrow><mi>x</mi><mo>,</mo><msub><mi>M</mi><mi>x</mi></msub></mrow></msub><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">P_{\text{med}} = P(Y_{x^*, M_x} &gt; Y_{x, M_x})</annotation></semantics></math></p>
<p>where:</p>
<ul><li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Y</mi><mrow><msup><mi>x</mi><mo>*</mo></msup><mo>,</mo><msub><mi>M</mi><mi>x</mi></msub></mrow></msub><annotation encoding="application/x-tex">Y_{x^*, M_x}</annotation></semantics></math>: Outcome under control (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>x</mi><mo>*</mo></msup><annotation encoding="application/x-tex">x^*</annotation></semantics></math>) with mediator at its treated level (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>M</mi><mi>x</mi></msub><annotation encoding="application/x-tex">M_x</annotation></semantics></math>)</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Y</mi><mrow><mi>x</mi><mo>,</mo><msub><mi>M</mi><mi>x</mi></msub></mrow></msub><annotation encoding="application/x-tex">Y_{x, M_x}</annotation></semantics></math>: Outcome under treatment (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics></math>) with mediator at its treated level (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>M</mi><mi>x</mi></msub><annotation encoding="application/x-tex">M_x</annotation></semantics></math>)</li>
</ul><p><strong>Interpretation</strong>: Probability that setting treatment to control (while keeping mediator at treated level) would increase the outcome. Values &gt; 0.5 indicate positive mediation.</p>
</div>
<div class="section level3">
<h3 id="p_med-computation-methods">P_med Computation Methods<a class="anchor" aria-label="anchor" href="#p_med-computation-methods"></a></h3>
<p><strong>1. Plugin Estimator</strong> (<code>method = "plugin"</code>):</p>
<ul><li>Point estimate only, no confidence interval</li>
<li>Fast computation via Monte Carlo integration</li>
<li>Use for quick checks or when inference not needed</li>
</ul><p><strong>2. Parametric Bootstrap</strong> (<code>method = "parametric_bootstrap"</code>):</p>
<ul><li>Samples from multivariate normal of parameter estimates</li>
<li>Faster than nonparametric; requires normality assumption</li>
<li>Default for most applications</li>
<li>Use: <code>n_boot = 1000</code> (minimum), <code>n_boot = 5000</code> (recommended)</li>
</ul><p><strong>3. Nonparametric Bootstrap</strong> (<code>method = "nonparametric_bootstrap"</code>):</p>
<ul><li>Resamples data and refits models</li>
<li>Robust to parameter distribution assumptions</li>
<li>Computationally intensive</li>
<li>Use when sample size adequate (n &gt; 100) and parametric assumptions questionable</li>
</ul></div>
<div class="section level3">
<h3 id="bootstrap-implementation">Bootstrap Implementation<a class="anchor" aria-label="anchor" href="#bootstrap-implementation"></a></h3>
<p>Both bootstrap methods follow this pattern:</p>
<ol style="list-style-type: decimal"><li>
<strong>Generate bootstrap samples</strong>
<ul><li>Parametric: Sample from <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo stretchy="false" form="prefix">(</mo><mover><mi>θ</mi><mo accent="true">̂</mo></mover><mo>,</mo><mover><mi mathvariant="normal">Σ</mi><mo accent="true">̂</mo></mover><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">N(\hat{\theta}, \hat{\Sigma})</annotation></semantics></math></li>
<li>Nonparametric: Resample data with replacement</li>
</ul></li>
<li>
<strong>Compute P_med for each sample</strong>
<ul><li>Parametric: Use sampled parameters directly</li>
<li>Nonparametric: Refit models, extract parameters, compute P_med</li>
</ul></li>
<li>
<strong>Extract empirical quantiles</strong>
<ul><li>CI: quantiles at <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mi>/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">\alpha/2</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>−</mo><mi>α</mi><mi>/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">1-\alpha/2</annotation></semantics></math></li>
<li>Point estimate: mean or median of bootstrap distribution</li>
</ul></li>
<li>
<strong>Return results</strong>
<ul><li>Full bootstrap distribution stored in <code>@boot_estimates</code>
</li>
<li>Enables diagnostic plots and summary statistics</li>
</ul></li>
</ol><p><strong>Memory considerations:</strong></p>
<ul><li>Bootstrap distributions stored in memory</li>
<li>Large <code>n_boot</code> with many parameters can consume substantial memory</li>
<li>For <code>n_boot &gt; 10000</code>, consider saving to disk and streaming</li>
</ul></div>
<div class="section level3">
<h3 id="handling-interactions">Handling Interactions<a class="anchor" aria-label="anchor" href="#handling-interactions"></a></h3>
<p>When exposure-mediator interactions are present (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mo>×</mo><mi>M</mi></mrow><annotation encoding="application/x-tex">X \times M</annotation></semantics></math> in outcome model):</p>
<p><strong>Conditioning approach:</strong></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/pmed.html">pmed</a></span><span class="op">(</span></span>
<span>  <span class="va">Y</span> <span class="op">~</span> <span class="va">X</span> <span class="op">+</span> <span class="va">M</span> <span class="op">+</span> <span class="va">X</span><span class="op">:</span><span class="va">M</span> <span class="op">+</span> <span class="va">C</span>,</span>
<span>  formula_m <span class="op">=</span> <span class="va">M</span> <span class="op">~</span> <span class="va">X</span> <span class="op">+</span> <span class="va">C</span>,</span>
<span>  data <span class="op">=</span> <span class="va">data</span>,</span>
<span>  treatment <span class="op">=</span> <span class="st">"X"</span>,</span>
<span>  mediator <span class="op">=</span> <span class="st">"M"</span>,</span>
<span>  condition_on_x <span class="op">=</span> <span class="fl">0</span>  <span class="co"># Evaluate P_med at X = 0</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>Options for <code>condition_on_x</code>:</strong></p>
<ul><li>Numeric value: Condition on specific X level</li>
<li>
<code>"mean"</code>: Marginalize over X distribution</li>
<li>Vector: Multiple conditioning values (returns list)</li>
</ul><p><strong>Mathematical note</strong>: With interactions, P_med becomes conditional on X level, as the mediation effect varies by treatment level.</p>
</div>
<div class="section level3">
<h3 id="multiple-mediators">Multiple Mediators<a class="anchor" aria-label="anchor" href="#multiple-mediators"></a></h3>
<p><strong>Parallel mediators</strong> (M1 and M2 both mediate X → Y):</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/pmed.html">pmed</a></span><span class="op">(</span></span>
<span>  formula_y <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="va">X</span> <span class="op">+</span> <span class="va">M1</span> <span class="op">+</span> <span class="va">M2</span> <span class="op">+</span> <span class="va">C</span>,</span>
<span>  formula_m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="va">M1</span> <span class="op">~</span> <span class="va">X</span> <span class="op">+</span> <span class="va">C</span>,</span>
<span>    <span class="va">M2</span> <span class="op">~</span> <span class="va">X</span> <span class="op">+</span> <span class="va">C</span></span>
<span>  <span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">data</span>,</span>
<span>  treatment <span class="op">=</span> <span class="st">"X"</span>,</span>
<span>  mediator <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"M1"</span>, <span class="st">"M2"</span><span class="op">)</span>,</span>
<span>  effect <span class="op">=</span> <span class="st">"total"</span>  <span class="co"># Total indirect effect</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>Sequential mediators</strong> (X → M1 → M2 → Y):</p>
<ul><li>Requires path-specific effect definition</li>
<li>Currently in development (Phase 3)</li>
<li>Will use nested counterfactuals</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="statistical-assumptions--diagnostics">Statistical Assumptions &amp; Diagnostics<a class="anchor" aria-label="anchor" href="#statistical-assumptions--diagnostics"></a></h2>
<div class="section level3">
<h3 id="key-assumptions">Key Assumptions<a class="anchor" aria-label="anchor" href="#key-assumptions"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Correct model specification</strong>:
<ul><li>Mediator model: E[M|X,C] correctly specified</li>
<li>Outcome model: E[Y|X,M,C] correctly specified</li>
<li>Misspecification biases P_med estimate</li>
</ul></li>
<li>
<strong>No unmeasured confounding</strong> (Imai et al., 2010):
<ul><li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">{</mo><msub><mi>Y</mi><mrow><mi>x</mi><mo>,</mo><mi>m</mi></mrow></msub><mo>,</mo><msub><mi>M</mi><mi>x</mi></msub><mo stretchy="false" form="postfix">}</mo><mo>⟂</mo><mi>X</mi><mo stretchy="false" form="prefix">|</mo><mi>C</mi></mrow><annotation encoding="application/x-tex">\{Y_{x,m}, M_x\} \perp X | C</annotation></semantics></math> (exposure-outcome)</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mrow><mi>x</mi><mo>,</mo><mi>m</mi></mrow></msub><mo>⟂</mo><mi>M</mi><mo stretchy="false" form="prefix">|</mo><mi>X</mi><mo>,</mo><mi>C</mi></mrow><annotation encoding="application/x-tex">Y_{x,m} \perp M | X, C</annotation></semantics></math> (mediator-outcome)</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mrow><mi>x</mi><mo>,</mo><mi>m</mi></mrow></msub><mo>⟂</mo><msub><mi>M</mi><msup><mi>x</mi><mo>*</mo></msup></msub></mrow><annotation encoding="application/x-tex">Y_{x,m} \perp M_{x^*}</annotation></semantics></math> (cross-world independence)</li>
<li>These are <em>untestable</em> assumptions; require subject-matter knowledge</li>
</ul></li>
<li>
<strong>Parameter normality</strong> (for parametric bootstrap):
<ul><li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">(</mo><mover><mi>a</mi><mo accent="true">̂</mo></mover><mo>,</mo><mover><mi>b</mi><mo accent="true">̂</mo></mover><mo>,</mo><msup><mover><mi>c</mi><mo accent="true">̂</mo></mover><mo>′</mo></msup><mo stretchy="false" form="postfix">)</mo><mo>∼</mo><mi>N</mi><mo stretchy="false" form="prefix">(</mo><mi>θ</mi><mo>,</mo><mi mathvariant="normal">Σ</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(\hat{a}, \hat{b}, \hat{c}') \sim N(\theta, \Sigma)</annotation></semantics></math></li>
<li>Generally reasonable for large samples (CLT)</li>
<li>Check with Q-Q plots of bootstrap samples</li>
</ul></li>
<li>
<strong>Correct link functions</strong>:
<ul><li>GLM families must match data types</li>
<li>Binary outcome: use <code>family = binomial()</code>
</li>
<li>Count outcome: use <code>family = poisson()</code>
</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="diagnostics">Diagnostics<a class="anchor" aria-label="anchor" href="#diagnostics"></a></h3>
<p><strong>Check bootstrap distribution:</strong></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/pmed.html">pmed</a></span><span class="op">(</span><span class="va">...</span>, method <span class="op">=</span> <span class="st">"parametric_bootstrap"</span>, n_boot <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot bootstrap distribution</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Summary statistics</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract bootstrap samples for custom diagnostics</span></span>
<span><span class="va">boot_dist</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">@</span><span class="va">boot_estimates</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">boot_dist</span><span class="op">)</span></span></code></pre></div>
<p><strong>Warning signs:</strong></p>
<ul><li>P_med outside [0, 1]: Model misspecification likely</li>
<li>Highly skewed bootstrap distribution: Consider nonparametric bootstrap</li>
<li>Wide CI relative to estimate: Large uncertainty, increase sample size</li>
<li>CI includes 0.5: Cannot conclude mediation direction</li>
</ul></div>
<div class="section level3">
<h3 id="common-pitfalls">Common Pitfalls<a class="anchor" aria-label="anchor" href="#common-pitfalls"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Ignoring confounders</strong>: Always adjust for common causes of M-Y</li>
<li>
<strong>Assuming causality from association</strong>: P_med quantifies <em>association</em>, not <em>causation</em>
</li>
<li>
<strong>Misinterpreting P_med = 0.5</strong>: This is the null (no mediation), not “50% mediation”</li>
<li>
<strong>Using plugin estimator for inference</strong>: Plugin gives no CI; always bootstrap</li>
<li>
<strong>Insufficient bootstrap samples</strong>: Use at least n_boot = 1000, preferably 5000+</li>
</ol></div>
</div>
<div class="section level2">
<h2 id="s7-method-dispatch">S7 Method Dispatch<a class="anchor" aria-label="anchor" href="#s7-method-dispatch"></a></h2>
<div class="section level3">
<h3 id="adding-new-extraction-methods">Adding New Extraction Methods<a class="anchor" aria-label="anchor" href="#adding-new-extraction-methods"></a></h3>
<p>To add support for a new package (e.g., <code>newpackage</code>):</p>
<ol style="list-style-type: decimal"><li>
<strong>Define S7 method</strong>:</li>
</ol><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Extract from newpackage</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="fu">S7</span><span class="fu">::</span><span class="fu"><a href="https://rconsortium.github.io/S7/reference/method.html" class="external-link">method</a></span><span class="op">(</span><span class="va">extract_mediation</span>, <span class="fu">newpackage</span><span class="fu">::</span><span class="va">fitted_model</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>,</span>
<span>                                                                     <span class="va">treatment</span>,</span>
<span>                                                                     <span class="va">mediator</span>,</span>
<span>                                                                     <span class="va">data</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                                                                     <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Extract parameters</span></span>
<span>  <span class="va">params</span> <span class="op">&lt;-</span> <span class="fu">newpackage</span><span class="fu">::</span><span class="fu">get_params</span><span class="op">(</span><span class="va">object</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Extract a, b, c' paths</span></span>
<span>  <span class="va">a_path</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">[</span><span class="va">treatment</span>, <span class="va">mediator</span><span class="op">]</span></span>
<span>  <span class="va">b_path</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">[</span><span class="va">mediator</span>, <span class="va">outcome</span><span class="op">]</span></span>
<span>  <span class="va">c_prime</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">[</span><span class="va">treatment</span>, <span class="va">outcome</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Get variance-covariance matrix</span></span>
<span>  <span class="va">vcov_mat</span> <span class="op">&lt;-</span> <span class="fu">newpackage</span><span class="fu">::</span><span class="fu">get_vcov</span><span class="op">(</span><span class="va">object</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Return MediationExtract</span></span>
<span>  <span class="fu"><a href="reference/MediationExtract.html">MediationExtract</a></span><span class="op">(</span></span>
<span>    estimates <span class="op">=</span> <span class="va">params</span>,</span>
<span>    a_path <span class="op">=</span> <span class="va">a_path</span>,</span>
<span>    b_path <span class="op">=</span> <span class="va">b_path</span>,</span>
<span>    c_prime <span class="op">=</span> <span class="va">c_prime</span>,</span>
<span>    vcov <span class="op">=</span> <span class="va">vcov_mat</span>,</span>
<span>    data <span class="op">=</span> <span class="va">data</span>,</span>
<span>    n_obs <span class="op">=</span> <span class="fu">newpackage</span><span class="fu">::</span><span class="fu">nobs</span><span class="op">(</span><span class="va">object</span><span class="op">)</span>,</span>
<span>    source_package <span class="op">=</span> <span class="st">"newpackage"</span>,</span>
<span>    converged <span class="op">=</span> <span class="fu">newpackage</span><span class="fu">::</span><span class="fu">converged</span><span class="op">(</span><span class="va">object</span><span class="op">)</span>,</span>
<span>    treatment <span class="op">=</span> <span class="va">treatment</span>,</span>
<span>    mediator <span class="op">=</span> <span class="va">mediator</span>,</span>
<span>    outcome <span class="op">=</span> <span class="fu">newpackage</span><span class="fu">::</span><span class="fu">get_outcome</span><span class="op">(</span><span class="va">object</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<ol start="2" style="list-style-type: decimal"><li>
<strong>Add to DESCRIPTION</strong>:</li>
</ol><pre><code><span><span class="va">Suggests</span><span class="op">:</span></span>
<span>    <span class="va">newpackage</span></span></code></pre>
<ol start="3" style="list-style-type: decimal"><li>
<strong>Add conditional requirement check</strong>:</li>
</ol><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"newpackage"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Package 'newpackage' needed. Install with: install.packages('newpackage')"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="creating-new-s7-classes">Creating New S7 Classes<a class="anchor" aria-label="anchor" href="#creating-new-s7-classes"></a></h3>
<p>When extending functionality with new classes:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' New Class for Extension</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">NewClass</span> <span class="op">&lt;-</span> <span class="fu">S7</span><span class="fu">::</span><span class="fu"><a href="https://rconsortium.github.io/S7/reference/new_class.html" class="external-link">new_class</a></span><span class="op">(</span></span>
<span>  <span class="st">"NewClass"</span>,</span>
<span>  package <span class="op">=</span> <span class="st">"probmed"</span>,</span>
<span>  parent <span class="op">=</span> <span class="va">MediationExtract</span>,  <span class="co"># Inherit from base class</span></span>
<span>  </span>
<span>  properties <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="co"># New properties specific to this class</span></span>
<span>    new_property <span class="op">=</span> <span class="fu">S7</span><span class="fu">::</span><span class="va"><a href="https://rconsortium.github.io/S7/reference/base_classes.html" class="external-link">class_numeric</a></span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  validator <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">self</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Validation logic</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">self</span><span class="op">@</span><span class="va">new_property</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="st">"new_property must be non-negative"</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="testing-strategy">Testing Strategy<a class="anchor" aria-label="anchor" href="#testing-strategy"></a></h2>
<div class="section level3">
<h3 id="unit-tests-should-cover">Unit Tests Should Cover<a class="anchor" aria-label="anchor" href="#unit-tests-should-cover"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>P_med Computation Accuracy</strong>
<ul><li>Compare to hand-calculated examples</li>
<li>Verify P_med ∈ [0, 1]</li>
<li>Check symmetry properties</li>
<li>Test with known effect sizes</li>
</ul></li>
<li>
<strong>Bootstrap Methods</strong>
<ul><li>Parametric vs nonparametric convergence with large n_boot</li>
<li>Reproducibility with set.seed()</li>
<li>CI coverage in simulations (should be ~95% for 95% CI)</li>
<li>Memory efficiency with large n_boot</li>
</ul></li>
<li>
<strong>S7 Validation</strong>
<ul><li>Property type checking works</li>
<li>Validators catch invalid inputs</li>
<li>Class inheritance functions correctly</li>
</ul></li>
<li>
<strong>Model Extraction</strong>
<ul><li>Identical results from lavaan object vs manual specification</li>
<li>Correct extraction from different model types</li>
<li>Proper handling of constrained parameters</li>
<li>Error handling for convergence failures</li>
</ul></li>
<li>
<strong>Edge Cases</strong>
<ul><li>Small sample sizes (n &lt; 50)</li>
<li>Near-zero mediation effects</li>
<li>Perfect mediation (P_med ≈ 1)</li>
<li>Suppression effects (P_med &lt; 0.5)</li>
<li>Missing data handling</li>
<li>Singular covariance matrices</li>
</ul></li>
<li>
<strong>Formula Interface</strong>
<ul><li>Correct parsing of formulas with interactions</li>
<li>Multiple mediators specification</li>
<li>Interaction detection and conditioning</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="test-organization">Test Organization<a class="anchor" aria-label="anchor" href="#test-organization"></a></h3>
<pre><code>tests/
├── testthat/
│   ├── test-classes.R           # S7 class validation
│   ├── test-pmed-glm.R          # GLM interface
│   ├── test-pmed-bootstrap.R    # Bootstrap methods
│   ├── test-extract-lavaan.R    # lavaan extraction
│   ├── test-interactions.R      # Interaction models
│   ├── test-multiple.R          # Multiple mediators
│   └── test-edge-cases.R        # Edge cases and errors
└── manual/
    └── validation-simulations.R  # Long-running validation</code></pre>
</div>
<div class="section level3">
<h3 id="coverage-expectations">Coverage Expectations<a class="anchor" aria-label="anchor" href="#coverage-expectations"></a></h3>
<ul><li>
<strong>Target</strong>: &gt;90% test coverage</li>
<li>
<strong>Critical paths</strong>: 100% coverage for P_med computation core</li>
<li>
<strong>Bootstrap</strong>: Coverage assessment via simulation studies</li>
<li>
<strong>CI coverage</strong>: Should be within ±2% of nominal level in simulations</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="key-mathematical-formulas">Key Mathematical Formulas<a class="anchor" aria-label="anchor" href="#key-mathematical-formulas"></a></h2>
<div class="section level3">
<h3 id="p_med-definition-1">P_med Definition<a class="anchor" aria-label="anchor" href="#p_med-definition-1"></a></h3>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mtext mathvariant="normal">med</mtext></msub><mo>=</mo><mi>P</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>Y</mi><mrow><msup><mi>x</mi><mo>*</mo></msup><mo>,</mo><msub><mi>M</mi><mi>x</mi></msub></mrow></msub><mo>&gt;</mo><msub><mi>Y</mi><mrow><mi>x</mi><mo>,</mo><msub><mi>M</mi><mi>x</mi></msub></mrow></msub><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mo>∫</mo><mi>P</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>Y</mi><mrow><msup><mi>x</mi><mo>*</mo></msup><mo>,</mo><msub><mi>M</mi><mi>x</mi></msub></mrow></msub><mo>&gt;</mo><msub><mi>Y</mi><mrow><mi>x</mi><mo>,</mo><msub><mi>M</mi><mi>x</mi></msub></mrow></msub><mo stretchy="false" form="prefix">|</mo><mi>C</mi><mo>=</mo><mi>c</mi><mo stretchy="false" form="postfix">)</mo><mi>d</mi><msub><mi>F</mi><mi>C</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>c</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">P_{\text{med}} = P(Y_{x^*, M_x} &gt; Y_{x, M_x}) = \int P(Y_{x^*, M_x} &gt; Y_{x, M_x} | C=c) dF_C(c)</annotation></semantics></math></p>
</div>
<div class="section level3">
<h3 id="simple-mediation-linear-models">Simple Mediation (Linear Models)<a class="anchor" aria-label="anchor" href="#simple-mediation-linear-models"></a></h3>
<p>For linear outcome model <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>=</mo><msub><mi>β</mi><mn>0</mn></msub><mo>+</mo><msub><mi>β</mi><mn>1</mn></msub><mi>X</mi><mo>+</mo><msub><mi>β</mi><mn>2</mn></msub><mi>M</mi><mo>+</mo><msub><mi>β</mi><mn>3</mn></msub><mi>C</mi><mo>+</mo><msub><mi>ϵ</mi><mi>Y</mi></msub></mrow><annotation encoding="application/x-tex">Y = \beta_0 + \beta_1 X + \beta_2 M + \beta_3 C + \epsilon_Y</annotation></semantics></math>:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mtext mathvariant="normal">med</mtext></msub><mo>=</mo><mi mathvariant="normal">Φ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mrow><mi>a</mi><mi>b</mi><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo>−</mo><msup><mi>x</mi><mo>*</mo></msup><mo stretchy="false" form="postfix">)</mo></mrow><msqrt><msubsup><mi>σ</mi><mi>Y</mi><mn>2</mn></msubsup></msqrt></mfrac><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P_{\text{med}} = \Phi\left(\frac{ab(x - x^*)}{\sqrt{\sigma^2_Y}}\right)</annotation></semantics></math></p>
<p>where:</p>
<ul><li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>a</mi><annotation encoding="application/x-tex">a</annotation></semantics></math> = effect of X on M</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math> = effect of M on Y</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi mathvariant="normal">Φ</mi><annotation encoding="application/x-tex">\Phi</annotation></semantics></math> = standard normal CDF</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mi>σ</mi><mi>Y</mi><mn>2</mn></msubsup><annotation encoding="application/x-tex">\sigma^2_Y</annotation></semantics></math> = residual variance of Y</li>
</ul></div>
<div class="section level3">
<h3 id="approximate-standard-error-delta-method">Approximate Standard Error (Delta Method)<a class="anchor" aria-label="anchor" href="#approximate-standard-error-delta-method"></a></h3>
<p>For parametric bootstrap, standard error approximated via:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>E</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>P</mi><mtext mathvariant="normal">med</mtext></msub><mo stretchy="false" form="postfix">)</mo><mo>≈</mo><msqrt><mrow><msub><mtext mathvariant="normal">Var</mtext><mover><mi>θ</mi><mo accent="true">̂</mo></mover></msub><mo stretchy="false" form="prefix">[</mo><msub><mi>P</mi><mtext mathvariant="normal">med</mtext></msub><mo stretchy="false" form="prefix">(</mo><mover><mi>θ</mi><mo accent="true">̂</mo></mover><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">]</mo></mrow></msqrt></mrow><annotation encoding="application/x-tex">SE(P_{\text{med}}) \approx \sqrt{\text{Var}_{\hat{\theta}}[P_{\text{med}}(\hat{\theta})]}</annotation></semantics></math></p>
<p>where variance computed empirically from bootstrap samples.</p>
</div>
<div class="section level3">
<h3 id="with-interactions">With Interactions<a class="anchor" aria-label="anchor" href="#with-interactions"></a></h3>
<p>When <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>=</mo><msub><mi>β</mi><mn>0</mn></msub><mo>+</mo><msub><mi>β</mi><mn>1</mn></msub><mi>X</mi><mo>+</mo><msub><mi>β</mi><mn>2</mn></msub><mi>M</mi><mo>+</mo><msub><mi>β</mi><mn>3</mn></msub><mi>X</mi><mi>M</mi><mo>+</mo><msub><mi>β</mi><mn>4</mn></msub><mi>C</mi><mo>+</mo><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">Y = \beta_0 + \beta_1 X + \beta_2 M + \beta_3 XM + \beta_4 C + \epsilon</annotation></semantics></math>:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mtext mathvariant="normal">med</mtext></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>x</mi><mn>0</mn></msub><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mi>P</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>Y</mi><mrow><msup><mi>x</mi><mo>*</mo></msup><mo>,</mo><msub><mi>M</mi><mi>x</mi></msub></mrow></msub><mo>&gt;</mo><msub><mi>Y</mi><mrow><mi>x</mi><mo>,</mo><msub><mi>M</mi><mi>x</mi></msub></mrow></msub><mo stretchy="false" form="prefix">|</mo><mi>X</mi><mo>=</mo><msub><mi>x</mi><mn>0</mn></msub><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">P_{\text{med}}(x_0) = P(Y_{x^*, M_x} &gt; Y_{x, M_x} | X = x_0)</annotation></semantics></math></p>
<p>Conditioning value <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>x</mi><mn>0</mn></msub><annotation encoding="application/x-tex">x_0</annotation></semantics></math> must be specified; P_med varies by treatment level.</p>
</div>
</div>
<div class="section level2">
<h2 id="integration-with-medrobust-package">Integration with medrobust Package<a class="anchor" aria-label="anchor" href="#integration-with-medrobust-package"></a></h2>
<p>The probmed package is designed to work seamlessly with medrobust for sensitivity analysis:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://data-wise.github.io/probmed/">probmed</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/data-wise/medrobust" class="external-link">medrobust</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute P_med</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/pmed.html">pmed</a></span><span class="op">(</span></span>
<span>  <span class="va">Y</span> <span class="op">~</span> <span class="va">X</span> <span class="op">+</span> <span class="va">M</span> <span class="op">+</span> <span class="va">C</span>,</span>
<span>  formula_m <span class="op">=</span> <span class="va">M</span> <span class="op">~</span> <span class="va">X</span> <span class="op">+</span> <span class="va">C</span>,</span>
<span>  data <span class="op">=</span> <span class="va">data</span>,</span>
<span>  treatment <span class="op">=</span> <span class="st">"X"</span>,</span>
<span>  mediator <span class="op">=</span> <span class="st">"M"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sensitivity analysis for unmeasured confounding</span></span>
<span><span class="va">sens</span> <span class="op">&lt;-</span> <span class="fu">medrobust</span><span class="fu">::</span><span class="fu">sensitivity_analysis</span><span class="op">(</span></span>
<span>  <span class="va">result</span>,</span>
<span>  rho_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.5</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sens</span><span class="op">)</span></span></code></pre></div>
<p><strong>medrobust should provide:</strong></p>
<ul><li>S7 method for <code>PmedResult</code> class</li>
<li>Sensitivity parameters: ρ (U → M, U → Y correlation)</li>
<li>Tipping point analysis</li>
<li>Visualization of P_med under confounding scenarios</li>
</ul></div>
<div class="section level2">
<h2 id="additional-resources">Additional Resources<a class="anchor" aria-label="anchor" href="#additional-resources"></a></h2>
<div class="section level3">
<h3 id="key-publications">Key Publications<a class="anchor" aria-label="anchor" href="#key-publications"></a></h3>
<p><strong>P_med Method:</strong></p>
<ul><li>Tofighi et al. (2025). P_med: A scale-free effect size for mediation analysis. <em>Psychological Methods</em>. (In preparation)</li>
</ul><p><strong>Causal Mediation Framework:</strong></p>
<ul><li>Imai, K., Keele, L., &amp; Tingley, D. (2010). A general approach to causal mediation analysis. <em>Psychological Methods</em>, 15(4), 309–334.</li>
<li>VanderWeele, T. J. (2015). <em>Explanation in Causal Inference: Methods for Mediation and Interaction</em>. Oxford University Press.</li>
<li>Pearl, J. (2001). Direct and indirect effects. <em>Proceedings of UAI</em>, 411–420.</li>
</ul><p><strong>Scale-Free Effect Sizes:</strong></p>
<ul><li>McGraw, K. O., &amp; Wong, S. P. (1992). A common language effect size statistic. <em>Psychological Bulletin</em>, 111(2), 361–365.</li>
<li>Vargha, A., &amp; Delaney, H. D. (2000). A critique and improvement of the CL common language effect size statistics of McGraw and Wong. <em>Journal of Educational and Behavioral Statistics</em>, 25(2), 101–132.</li>
</ul><p><strong>Multiple Mediators:</strong></p>
<ul><li>VanderWeele, T. J., &amp; Vansteelandt, S. (2014). Mediation analysis with multiple mediators. <em>European Journal of Epidemiology</em>, 29(11), 801–810.</li>
<li>Daniel, R. M., De Stavola, B. L., Cousens, S. N., &amp; Vansteelandt, S. (2015). Causal mediation analysis with multiple mediators. <em>Biometrics</em>, 71(1), 1–14.</li>
</ul><p><strong>Sensitivity Analysis:</strong></p>
<ul><li>Imai, K., Keele, L., &amp; Yamamoto, T. (2010). Identification, inference and sensitivity analysis for causal mediation effects. <em>Statistical Science</em>, 25(1), 51–71.</li>
<li>VanderWeele, T. J. (2010). Bias formulas for sensitivity analysis for direct and indirect effects. <em>Epidemiology</em>, 21(4), 540–551.</li>
</ul></div>
<div class="section level3">
<h3 id="package-website">Package Website<a class="anchor" aria-label="anchor" href="#package-website"></a></h3>
<ul><li>GitHub: <a href="https://github.com/data-wise/probmed" class="external-link uri">https://github.com/data-wise/probmed</a>
</li>
<li>Documentation: <a href="https://data-wise.github.io/probmed" class="uri">https://data-wise.github.io/probmed</a>
</li>
<li>CRAN: (Upon release)</li>
</ul></div>
<div class="section level3">
<h3 id="related-packages">Related Packages<a class="anchor" aria-label="anchor" href="#related-packages"></a></h3>
<ul><li>
<strong>mediation</strong>: General mediation analysis (Tingley et al.)</li>
<li>
<strong>lavaan</strong>: Structural equation modeling (Rosseel)</li>
<li>
<strong>medflex</strong>: Natural effects models (Steen et al.)</li>
<li>
<strong>medrobust</strong>: Sensitivity analysis (Tofighi, companion package)</li>
<li>
<strong>RMediation</strong>: Confidence intervals for indirect effects (Tofighi &amp; MacKinnon)</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="development-roadmap">Development Roadmap<a class="anchor" aria-label="anchor" href="#development-roadmap"></a></h2>
<div class="section level3">
<h3 id="phase-1-core-functionality-current">Phase 1: Core Functionality (Current)<a class="anchor" aria-label="anchor" href="#phase-1-core-functionality-current"></a></h3>
<ul class="task-list"><li><label><input type="checkbox" checked>S7 class architecture</label></li>
<li><label><input type="checkbox" checked>Formula interface with GLM</label></li>
<li><label><input type="checkbox" checked>Bootstrap inference methods</label></li>
<li><label><input type="checkbox" checked>Basic extraction from lm/glm</label></li>
<li><label><input type="checkbox" checked>Print/summary/plot methods</label></li>
</ul></div>
<div class="section level3">
<h3 id="phase-2-model-integration-weeks-6-9">Phase 2: Model Integration (Weeks 6-9)<a class="anchor" aria-label="anchor" href="#phase-2-model-integration-weeks-6-9"></a></h3>
<ul class="task-list"><li><label><input type="checkbox">lavaan extraction</label></li>
<li><label><input type="checkbox">mediation package extraction</label></li>
<li><label><input type="checkbox">medflex extraction</label></li>
<li><label><input type="checkbox">Comprehensive testing</label></li>
</ul></div>
<div class="section level3">
<h3 id="phase-3-extensions-months-3-6">Phase 3: Extensions (Months 3-6)<a class="anchor" aria-label="anchor" href="#phase-3-extensions-months-3-6"></a></h3>
<ul class="task-list"><li><label><input type="checkbox">Exposure-mediator interactions</label></li>
<li><label><input type="checkbox">Multiple parallel mediators</label></li>
<li><label><input type="checkbox">Sequential mediators (path-specific)</label></li>
<li><label><input type="checkbox">Integration with medrobust</label></li>
</ul></div>
<div class="section level3">
<h3 id="phase-4-advanced-features-future">Phase 4: Advanced Features (Future)<a class="anchor" aria-label="anchor" href="#phase-4-advanced-features-future"></a></h3>
<ul class="task-list"><li><label><input type="checkbox">Longitudinal mediation</label></li>
<li><label><input type="checkbox">High-dimensional mediators</label></li>
<li><label><input type="checkbox">Bayesian estimation (via Stan/JAGS)</label></li>
<li><label><input type="checkbox">Multiply robust estimation</label></li>
</ul></div>
</div>
<div class="section level2">
<h2 id="troubleshooting-integrations">Troubleshooting Integrations<a class="anchor" aria-label="anchor" href="#troubleshooting-integrations"></a></h2>
<div class="section level3">
<h3 id="lavaan">lavaan<a class="anchor" aria-label="anchor" href="#lavaan"></a></h3>
<ul><li>
<strong>Error: “lavaan model did not converge”</strong>: Check your model specification and data. Try increasing iterations or changing the estimator.</li>
<li>
<strong>Error: “Can’t find method for extract_mediation(S4<lavaan>)”</lavaan></strong>: Ensure <code>lavaan</code> is installed and loaded. If using in a package, ensure <code>lavaan</code> is in Suggests and the method is registered in <code>.onLoad</code>.</li>
<li>
<strong>Warning: “Variance-covariance matrix corresponds to unstandardized estimates”</strong>: When using <code>standardized=TRUE</code>, be aware that the vcov matrix is still for unstandardized parameters. Bootstrap is recommended for inference on standardized effects.</li>
</ul></div>
<div class="section level3">
<h3 id="mediation">mediation<a class="anchor" aria-label="anchor" href="#mediation"></a></h3>
<ul><li>
<strong>Error: “The mediate object does not contain the underlying models”</strong>: Ensure you passed the model objects to <code>mediate()</code>.</li>
<li>
<strong>Note</strong>: <code>probmed</code> extracts the underlying <code>lm</code>/<code>glm</code> models. If <code>mediate()</code> was run with custom matrices or other inputs, extraction might fail.</li>
</ul></div>
</div>
</div>


  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://orcid.org/0000-0001-8523-7776" class="external-link">Davood Tofighi</a> Built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a></p>
</div>

<div class="pkgdown-footer-right">
  <p>Version {version}</p>
</div>

    </footer></div>





  </body></html>

